<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Host — Quest Control</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;background:#0b1220;color:#fff}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    .card{background:#111a2e;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;margin-bottom:14px}
    .muted{color:rgba(255,255,255,.7);font-size:13px}
    .row{display:flex;justify-content:space-between;align-items:center;padding:12px 10px;border-radius:12px;background:rgba(255,255,255,.04);margin-top:10px}
    .btn{background:#2563eb;color:#fff;border:none;padding:10px 12px;border-radius:12px;cursor:pointer}
    .danger{background:#ef4444}
    .ok{color:#22c55e}
    .err{color:#ef4444}
    .switch{position:relative;display:inline-block;width:52px;height:28px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.18);transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;bottom:3px;background:#fff;transition:.2s;border-radius:999px}
    input:checked + .slider{background:#22c55e}
    input:checked + .slider:before{transform:translateX(24px)}
    code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 style="margin:0 0 6px;">Host Panel</h1>
      <div class="muted" id="pinLine"></div>
      <div class="muted" id="syncLine" style="margin-top:6px;"></div>

      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
        <button class="btn" id="openAll">Open all</button>
        <button class="btn danger" id="closeAll">Close all</button>
        <button class="btn" id="refresh">Refresh</button>
      </div>

      <div id="msg" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px;font-size:18px;">Tasks (1–9)</h2>
      <div id="list"></div>
    </div>
  </div>

  <script>
    // === YOUR GOOGLE APPS SCRIPT WEB APP URL (/exec) ===
    const API_URL = "https://script.google.com/macros/s/AKfycbydEfcehBVvHQyG5s9vYvk2Cf8Ic26kWx-kP2XsRPNGFMGKgS7ecGW1ypHPdfeh5RxK/exec";

    const TOTAL = 9;

    const params = new URLSearchParams(location.search);
    const pin = (params.get("pin") || "").trim();

    document.getElementById("pinLine").innerHTML =
      pin
        ? `PIN: <b>provided</b> (<code>?pin=****</code>)`
        : `<span class="err">No PIN. Open like: <code>host.html?pin=7777</code></span>`;

    function setMsg(text, ok=true) {
      const el = document.getElementById("msg");
      el.className = ok ? "muted ok" : "muted err";
      el.textContent = text;
    }

    async function loadStatuses() {
      try {
        const res = await fetch(API_URL, { cache: "no-store" });
        const arr = await res.json(); // ["open","close",...]
        render(arr);
        document.getElementById("syncLine").textContent =
          `Last sync: ${new Date().toLocaleTimeString()}`;
      } catch (e) {
        setMsg("Cannot load statuses: " + e.message, false);
      }
    }

    function render(arr) {
      const container = document.getElementById("list");
      container.innerHTML = "";

      for (let i = 1; i <= TOTAL; i++) {
        const st = String(arr?.[i-1] || "close").trim().toLowerCase();
        const checked = st === "open";

        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div>
            <div style="font-weight:600;">Task ${i}</div>
            <div class="muted">${checked ? "OPEN" : "CLOSED"}</div>
          </div>
          <label class="switch">
            <input type="checkbox" ${checked ? "checked" : ""} data-id="${i}">
            <span class="slider"></span>
          </label>
        `;
        container.appendChild(row);
      }

      container.querySelectorAll("input[type=checkbox]").forEach(cb => {
        cb.addEventListener("change", async (e) => {
          const id = Number(e.target.dataset.id);
          const status = e.target.checked ? "open" : "close";
          await setStatus(id, status);
        });
      });
    }

    async function setStatus(taskId, status) {
      if (!pin) {
        setMsg("Missing PIN. Use host.html?pin=7777", false);
        return;
      }

      try {
        const body = new URLSearchParams({
          taskId: String(taskId),
          status,
          pin
        });

        // IMPORTANT: Apps Script blocks cross-site POST in normal CORS mode.
        // no-cors lets the request be sent. We confirm by GET after.
        await fetch(API_URL, {
          method: "POST",
          mode: "no-cors",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
          },
          body: body.toString()
        });

        setMsg(`Sent: Task ${taskId} -> ${status.toUpperCase()} (syncing...)`, true);

        // Confirm by reading statuses again
        setTimeout(loadStatuses, 900);
      } catch (e) {
        setMsg("POST failed: " + e.message, false);
      }
    }

    async function setAll(status) {
      for (let i = 1; i <= TOTAL; i++) {
        await setStatus(i, status);
        await new Promise(r => setTimeout(r, 120)); // small spacing
      }
      setTimeout(loadStatuses, 900);
    }

    document.getElementById("openAll").addEventListener("click", () => setAll("open"));
    document.getElementById("closeAll").addEventListener("click", () => setAll("close"));
    document.getElementById("refresh").addEventListener("click", loadStatuses);

    loadStatuses();
  </script>
</body>
</html>
