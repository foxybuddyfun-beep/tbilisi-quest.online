<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Host — Team 1</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;background:#0b1220;color:#fff}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    .card{background:#111a2e;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;margin-bottom:14px}
    .muted{color:rgba(255,255,255,.7);font-size:13px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px 10px;border-radius:12px;background:rgba(255,255,255,.04);margin-top:10px}
    .left{min-width:0}
    .title{font-weight:650}
    .sub{color:rgba(255,255,255,.7);font-size:12px;margin-top:3px}
    .btn{background:#2563eb;color:#fff;border:none;padding:10px 12px;border-radius:12px;cursor:pointer}
    .danger{background:#ef4444}
    .ok{color:#22c55e}
    .err{color:#ef4444}
    .switch{position:relative;display:inline-block;width:52px;height:28px;flex:0 0 auto}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.18);transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;bottom:3px;background:#fff;transition:.2s;border-radius:999px}
    input:checked + .slider{background:#22c55e}
    input:checked + .slider:before{transform:translateX(24px)}
    .answers a{color:#93c5fd;text-decoration:underline;cursor:pointer;margin-left:10px;white-space:nowrap}
    .answerBox{color:#fff;margin-left:10px;font-size:12px}
    code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 style="margin:0 0 6px;" id="hTitle">Host</h1>
      <div class="muted" id="pinLine"></div>
      <div class="muted" id="syncLine"></div>

      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
        <button class="btn" id="refresh">Refresh</button>
        <button class="btn" id="openAll">Open all</button>
        <button class="btn danger" id="closeAll">Close all</button>
      </div>

      <div id="msg" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px;font-size:18px;">Controls</h2>
      <div id="list"></div>
    </div>
  </div>

  <script type="module">
    import { API_URL } from "./config.js";
    import { LOCATIONS, TASKS, TEAM_ORDERS } from "./data.js";

    const TEAM_ID = 1;

    const params = new URLSearchParams(location.search);
    const pin = (params.get("pin") || "").trim();

    document.getElementById("pinLine").innerHTML =
      pin ? `PIN: <b>provided</b>` : `<span class="err">No PIN. Open like: <code>host-1.html?pin=7777</code></span>`;

    function setMsg(text, ok=true){
      const el = document.getElementById("msg");
      el.className = ok ? "muted ok" : "muted err";
      el.textContent = text;
    }

    // stepIdx 0..8 -> item 1..18
    function itemIndex(stepIdx, type){
      return type === "location" ? (2 * stepIdx + 1) : (2 * stepIdx + 2);
    }

    async function getTeam(){
      const res = await fetch(`${API_URL}?team=${TEAM_ID}`, { cache:"no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json(); // {teamName, statuses}
    }

    async function setStatus(item, status){
      if (!pin) { setMsg("Missing PIN. Add ?pin=7777", false); return; }

      const body = new URLSearchParams({
        team: String(TEAM_ID),
        item: String(item),
        status,
        pin
      });

      // no-cors: request is sent; we confirm by GET after
      await fetch(API_URL, {
        method:"POST",
        mode:"no-cors",
        headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
        body: body.toString()
      });
    }

    function render(teamName, statuses){
      document.getElementById("hTitle").textContent = `Host — Team ${TEAM_ID} — ${teamName || ""}`;
      document.getElementById("syncLine").textContent = `Last sync: ${new Date().toLocaleTimeString()}`;

      const order = TEAM_ORDERS[TEAM_ID];
      const list = document.getElementById("list");
      list.innerHTML = "";

      order.forEach((key, i) => {
        const locItem = itemIndex(i,"location");
        const taskItem = itemIndex(i,"task");

        const locOpen = (statuses[locItem-1] || "close") === "open";
        const taskOpen = (statuses[taskItem-1] || "close") === "open";

        // Location row
        const locRow = document.createElement("div");
        locRow.className = "row";
        locRow.innerHTML = `
          <div class="left">
            <div class="title">${i+1}. ${LOCATIONS[key].title}</div>
            <div class="sub">Location visibility</div>
          </div>
          <label class="switch">
            <input type="checkbox" ${locOpen ? "checked":""} data-item="${locItem}">
            <span class="slider"></span>
          </label>
        `;
        list.appendChild(locRow);

        // Task row (+ answer reveal)
        const answersHtml =
          TASKS[key].answers.length === 1
            ? `<a data-a="0">Answer</a>`
            : TASKS[key].answers.map((_,idx)=>`<a data-a="${idx}">Answer ${idx+1}</a>`).join("");

        const taskRow = document.createElement("div");
        taskRow.className = "row";
        taskRow.innerHTML = `
          <div class="left">
            <div class="title">${TASKS[key].title}</div>
            <div class="sub">
              Task visibility
              <span class="answers" data-key="${key}">
                ${answersHtml}
                <span class="answerBox"></span>
              </span>
            </div>
          </div>
          <label class="switch">
            <input type="checkbox" ${taskOpen ? "checked":""} data-item="${taskItem}">
            <span class="slider"></span>
          </label>
        `;
        list.appendChild(taskRow);
      });

      // Toggle handlers
      list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener("change", async (e) => {
          const item = Number(e.target.dataset.item);
          const status = e.target.checked ? "open" : "close";
          try {
            await setStatus(item, status);
            setMsg(`Sent: item ${item} -> ${status.toUpperCase()} (syncing...)`, true);
            setTimeout(load, 900);
          } catch (err) {
            setMsg("POST failed: " + err.message, false);
          }
        });
      });

      // Answer reveal (3 seconds)
      list.querySelectorAll(".answers").forEach(box => {
        const key = box.dataset.key;
        const out = box.querySelector(".answerBox");

        box.querySelectorAll("a[data-a]").forEach(a => {
          a.addEventListener("click", () => {
            const idx = Number(a.dataset.a);
            const answer = TASKS[key].answers[idx] || "";
            out.textContent = answer;
            setTimeout(() => { out.textContent = ""; }, 3000);
          });
        });
      });
    }

    async function load(){
      const data = await getTeam();
      render(data.teamName, data.statuses || []);
    }

    async function setAll(status){
      for (let item = 1; item <= 18; item++){
        await setStatus(item, status);
        await new Promise(r => setTimeout(r, 120));
      }
      setTimeout(load, 900);
    }

    document.getElementById("refresh").addEventListener("click", load);
    document.getElementById("openAll").addEventListener("click", ()=>setAll("open"));
    document.getElementById("closeAll").addEventListener("click", ()=>setAll("close"));

    try {
      await load();
    } catch (e) {
      setMsg("Cannot load team: " + e.message, false);
    }
  </script>
</body>
</html>
